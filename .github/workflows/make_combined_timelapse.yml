name: Build Combined Timelapse

on:
  workflow_dispatch:   # only manual trigger

permissions:
  contents: write

jobs:
  timelapse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Clean timelapses folder
        run: rm -rf timelapses && mkdir -p timelapses

      - name: Generate combined timelapse video
        id: build
        run: |
          python make_timelapse_combined.py | tee build_log.txt
          used=$(grep "Used" build_log.txt | awk '{print $2}')
          skipped=$(grep "skipped" build_log.txt | awk '{print $6}')
          echo "frames_used=$used" >> $GITHUB_OUTPUT
          echo "frames_skipped=$skipped" >> $GITHUB_OUTPUT

      - name: Add summary
        run: |
          echo "## ðŸŽžï¸ Combined Timelapse Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Frames used:** ${{ steps.build.outputs.frames_used }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frames skipped:** ${{ steps.build.outputs.frames_skipped }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Video generated successfully and ready for release upload." >> $GITHUB_STEP_SUMMARY

      - name: Create unique tag for release
        id: tag
        run: echo "tag=timelapse-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Upload timelapse to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Timelapse ${{ steps.tag.outputs.tag }}"
          files: timelapses/timelapse_combined_*.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
