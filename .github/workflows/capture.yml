name: Capture Webcam Image (every 4 minutes)

on:
  schedule:
    - cron: "*/4 * * * *"     # every 4 minutes (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: capture-every4min
  cancel-in-progress: true

env:
  CAMERA_HOST: recursos.sierranevada.es
  CAMERA_PATH: "/_extras/fotos_camaras/pradollano/snap_c1.jpg"

jobs:
  capture:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # Resolve IP fresh each run using public DNS, but don't write any repo files.
      - name: Resolve camera IP (runtime only)
        id: resolve
        run: |
          set -e

          echo "Resolving ${CAMERA_HOST} via public resolvers…"

          IP=""
          for resolver in 1.1.1.1 8.8.8.8; do
            echo "  -> trying $resolver"
            CANDIDATE="$(dig +short ${CAMERA_HOST} @$resolver A | head -n1 || true)"
            if [ -n "$CANDIDATE" ]; then
              IP="$CANDIDATE"
              echo "Resolved ${CAMERA_HOST} -> $IP via $resolver"
              break
            fi
          done

          if [ -z "$IP" ]; then
            echo "⚠️ Could not resolve IP via public resolvers. Will fall back to normal DNS in curl."
            echo "CAMERA_IP=" >> "$GITHUB_ENV"
          else
            echo "CAMERA_IP=$IP" >> "$GITHUB_ENV"
          fi

      - name: Capture image (try IP first, then DNS)
        run: |
          set -e

          URL="https://${CAMERA_HOST}${CAMERA_PATH}"
          OUT_DIR="images_5min"
          mkdir -p "$OUT_DIR"

          # Timestamp in Europe/Madrid for filename
          TS="$(TZ=Europe/Madrid date +'%y%m%d_%H%M%S')"
          OUT_FILE="${OUT_DIR}/image_${TS}.jpg"

          echo "===== Capture run at $TS ====="
          echo "Target URL: $URL"
          echo "Resolved IP (if any): ${CAMERA_IP:-<none>}"
          echo

          capture_ok=false

          # Function: attempt capture with a given curl command
          try_capture() {
            desc="$1"
            shift
            echo "Trying capture via: $desc"
            if curl -fSL \
                  --retry 4 \
                  --retry-delay 5 \
                  --connect-timeout 10 \
                  --max-time 40 \
                  -A "SierraTimelapseBot/1.0 (+https://github.com/mmiiffii/Sierra-Timeplase)" \
                  "$@" \
                  "$URL" -o "$OUT_FILE"; then
              echo "✅ Capture succeeded via: $desc"
              capture_ok=true
            else
              echo "⚠️ Capture failed via: $desc"
              rm -f "$OUT_FILE" || true
            fi
          }

          # 1) If we have an IP, try IP-based capture with --resolve (bypasses GitHub DNS)
          if [ -n "${CAMERA_IP:-}" ]; then
            try_capture "IP + --resolve" \
              --resolve "${CAMERA_HOST}:443:${CAMERA_IP}" \
              -H "Host: ${CAMERA_HOST}"
          else
            echo "No CAMERA_IP available from resolver step."
          fi

          # 2) If still not OK, try normal DNS (maybe GitHub's resolver works now)
          if [ "$capture_ok" = false ]; then
            try_capture "plain DNS" 
          fi

          # Final check
          if [ "$capture_ok" = false ]; then
            echo "❌ All capture attempts failed. No image saved this run."
            # Make this a hard failure so you *know* about it.
            exit 1
          fi

          ls -lh "$OUT_FILE" || true
          echo "================================="

      - name: Commit and push new images
        if: success()    # only commit if capture actually succeeded
        run: |
          set -e
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add images_5min/ || true
          git commit -m "Add 4-min capture" || echo "No changes"

          git fetch origin main
          git pull --rebase origin main || true
          git push origin HEAD:main || echo "⚠️ Push failed (likely race with another job, safe to ignore)"
