name: Capture Webcam Image (every 4 minutes)

on:
  schedule:
    - cron: "*/4 * * * *"     # every 4 minutes (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: capture-every4min
  cancel-in-progress: true

env:
  CAMERA_HOST: recursos.sierranevada.es
  CAMERA_IP: 123.45.67.89     # <-- put the IP that is currently working for you
  CAMERA_PATH: "/_extras/fotos_camaras/pradollano/snap_c1.jpg"

jobs:
  capture:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # Debug-only: log what DNS sees right now (does NOT affect capture)
      - name: Debug DNS for camera host
        run: |
          echo "### DNS debug for ${CAMERA_HOST} ###"
          which nslookup || echo "nslookup not found"
          which dig || echo "dig not found"

          echo
          echo "nslookup (if available):"
          nslookup "${CAMERA_HOST}" || echo "nslookup failed"

          echo
          echo "dig (if available):"
          dig +short "${CAMERA_HOST}" || echo "dig failed or not installed"

          echo "#####################################"

      - name: Capture image via IP (DNS bypass)
        run: |
          set -e

          if [ -z "${CAMERA_IP:-}" ]; then
            echo "❌ CAMERA_IP is not set. Please set it in the env block of this workflow."
            exit 1
          fi

          URL="https://${CAMERA_HOST}${CAMERA_PATH}"
          OUT_DIR="images_5min"
          mkdir -p "$OUT_DIR"

          # Timestamp in Europe/Madrid for filename
          TS="$(TZ=Europe/Madrid date +'%y%m%d_%H%M%S')"
          OUT_FILE="${OUT_DIR}/image_${TS}.jpg"

          echo "Attempting capture at $TS"
          echo "Using ${CAMERA_HOST} resolved to fixed IP ${CAMERA_IP}"

          # Use the IP directly but keep correct Host header for TLS
          if curl -fSL \
                --retry 2 \
                --retry-delay 5 \
                --connect-timeout 10 \
                --max-time 25 \
                --resolve "${CAMERA_HOST}:443:${CAMERA_IP}" \
                -H "Host: ${CAMERA_HOST}" \
                -A "SierraTimelapseBot/1.0 (+https://github.com/mmiiffii/Sierra-Timeplase)" \
                "$URL" -o "$OUT_FILE"; then
            echo "✅ Saved $OUT_FILE"
          else
            echo "⚠️  Failed to fetch image (network / HTTP error). Skipping this frame."
            rm -f "$OUT_FILE" || true
          fi

      - name: Commit and push new images
        run: |
          set -e
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add images_5min/ || true
          git commit -m "Add 4-min capture" || echo "No changes"

          git fetch origin main
          git pull --rebase origin main || true
          git push origin HEAD:main || echo "⚠️ Push failed (likely race with another job, safe to ignore)"
