name: Capture Webcam Image (5-Minute Interval)

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes (UTC)
  workflow_dispatch:         # allow manual trigger

permissions:
  contents: write

jobs:
  capture:
    runs-on: ubuntu-latest
    concurrency:
      group: capture_job
      cancel-in-progress: true   # prevents overlap if a run is delayed

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Capture image (tolerant + lightweight)
        run: |
          python3 - << 'PYCODE'
          import sys, time, random
          from pathlib import Path
          from urllib.request import urlopen, Request
          from urllib.error import URLError, HTTPError

          URL = "https://recursos.sierranevada.es/_extras/fotos_camaras/pradollano/snap_c1.jpg"
          OUT_DIR = Path("images_5min")
          OUT_DIR.mkdir(parents=True, exist_ok=True)

          # Small random jitter so we don't always hit the camera at the exact same second
          jitter = random.randint(0, 20)
          time.sleep(jitter)

          ts = time.strftime("%y%m%d_%H%M%S", time.gmtime())
          filename = f"image_{ts}.jpg"
          path = OUT_DIR / filename

          headers = {
              "User-Agent": "SierraTimelapseBot/1.0 (+https://github.com/mmiiffii/Sierra-Timeplase)",
              "Accept": "image/*,application/octet-stream;q=0.9,*/*;q=0.8",
          }

          try:
              req = Request(URL, headers=headers)
              with urlopen(req, timeout=20) as resp:
                  status = getattr(resp, "status", 200)
                  if status != 200:
                      print(f"⚠️  Camera returned HTTP {status}, skipping this capture.")
                      sys.exit(0)
                  data = resp.read()
          except (URLError, HTTPError) as e:
              print("⚠️  Skipping this capture – network / DNS error while fetching image:")
              print("   ", e)
              # Exit 0 so the workflow is "success" but we just didn't get a frame
              sys.exit(0)

          if not data:
              print("⚠️  Received empty response, skipping save.")
              sys.exit(0)

          # Avoid overwriting if timestamp collides for any reason
          base, ext = path.stem, path.suffix
          i = 1
          while path.exists():
              path = OUT_DIR / f"{base}_{i}{ext}"
              i += 1

          with open(path, "wb") as f:
              f.write(data)

          print(f"✅ Saved {path}")
          PYCODE

      - name: Commit and push image
        run: |
          set -e
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add images_5min/ || true
          git commit -m "Add 5-min capture" || echo "No changes"

          git fetch origin main
          git pull --rebase origin main || true
          git push origin HEAD:main || echo "Push failed (likely race with another job)"
