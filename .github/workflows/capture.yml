name: Capture Webcam Image (every 4 minutes)

on:
  schedule:
    - cron: "*/4 * * * *"     # every 4 minutes (UTC)
  workflow_dispatch:           # manual trigger

permissions:
  contents: write

concurrency:
  group: capture-every4min
  cancel-in-progress: true

env:
  CAMERA_HOST: recursos.sierranevada.es
  CAMERA_IP: 93.95.210.77      # <-- REPLACE with the IP from nslookup
  CAMERA_PATH: "/_extras/fotos_camaras/pradollano/snap_c1.jpg"

jobs:
  capture:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Capture image via IP (DNS bypass)
        run: |
          set -e

          URL="https://${CAMERA_HOST}${CAMERA_PATH}"
          OUT_DIR="images_5min"
          mkdir -p "$OUT_DIR"

          # Timestamp in Europe/Madrid for filename consistency
          TS="$(TZ=Europe/Madrid date +'%y%m%d_%H%M%S')"
          OUT_FILE="${OUT_DIR}/image_${TS}.jpg"

          echo "Attempting capture at $TS"
          echo "Using IP ${CAMERA_IP} for host ${CAMERA_HOST}"

          # Hit the IP directly, but send the correct Host header for HTTPS
          if curl -fSL \
                --retry 3 \
                --retry-delay 5 \
                --connect-timeout 10 \
                --max-time 25 \
                --resolve "${CAMERA_HOST}:443:${CAMERA_IP}" \
                -H "Host: ${CAMERA_HOST}" \
                -A "SierraTimelapseBot/1.0 (+https://github.com/mmiiffii/Sierra-Timeplase)" \
                "$URL" -o "$OUT_FILE"; then
            echo "✅ Saved $OUT_FILE"
          else
            echo "⚠️  Failed to fetch image (network / HTTP error). Skipping this frame."
            rm -f "$OUT_FILE" || true
          fi

      - name: Commit and push new images
        run: |
          set -e
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add images_5min/ || true
          git commit -m "Add 4-min capture" || echo "No changes"

          git fetch origin main
          git pull --rebase origin main || true
          git push origin HEAD:main || echo "⚠️ Push failed (likely race with another job, safe to ignore)"
